function gA_TC = CSred_TC_line(v0_range, options)
% Calculates transcritical bifurcation coordinates in 
% reduced CS model

%% Constants

%Reversal potentials
ENa = 55;
EKDR = -75;
El = -17;

% conductances
gl = 0.3;
gNa = 120;
gKDR = 20;


%% functions_CS

% Partials with v0 as dynamical variable and without timescale
dVdVC_v0 = @(V, n, gA) -120/((exp(224164298057848/1304196378821855 - (613455931296362*log(1/n - 1))/260839275764371) + 1)*(exp(- (562949953421312*V)/5329489831328509 - 16739365515052668/5329489831328509) + 1)^3) - 20*n^4 - gA/((exp(- (35184372088832*V)/1820115906168013 - 2678129957135078/1820115906168013) + 1)^3*(exp(9399834565864460/3215394367055963 - (4600919484722715*log(1/n - 1))/3215394367055963) + 1)) - (202661983231672320*exp(- (562949953421312*V)/5329489831328509 - 16739365515052668/5329489831328509)*(V - 55))/(5329489831328509*(exp(224164298057848/1304196378821855 - (613455931296362*log(1/n - 1))/260839275764371) + 1)*(exp(- (562949953421312*V)/5329489831328509 - 16739365515052668/5329489831328509) + 1)^4) - (105553116266496*gA*exp(- (35184372088832*V)/1820115906168013 - 2678129957135078/1820115906168013)*(V + 75))/(1820115906168013*(exp(- (35184372088832*V)/1820115906168013 - 2678129957135078/1820115906168013) + 1)^4*(exp(9399834565864460/3215394367055963 - (4600919484722715*log(1/n - 1))/3215394367055963) + 1)) - 3/10;
dVdnC_v0 = @(V, n, gA) (73614711755563440*exp(224164298057848/1304196378821855 - (613455931296362*log(1/n - 1))/260839275764371)*(V - 55))/(260839275764371*n^2*(exp(224164298057848/1304196378821855 - (613455931296362*log(1/n - 1))/260839275764371) + 1)^2*(1/n - 1)*(exp(- (562949953421312*V)/5329489831328509 - 16739365515052668/5329489831328509) + 1)^3) - 80*n^3*(V + 75) + (4600919484722715*gA*exp(9399834565864460/3215394367055963 - (4600919484722715*log(1/n - 1))/3215394367055963)*(V + 75))/(3215394367055963*n^2*(exp(- (35184372088832*V)/1820115906168013 - 2678129957135078/1820115906168013) + 1)^3*(1/n - 1)*(exp(9399834565864460/3215394367055963 - (4600919484722715*log(1/n - 1))/3215394367055963) + 1)^2);

% Partials of steady state values
dm3dV = @(V) (1688849860263936*exp(- (562949953421312*V)/5329489831328509 - 16739365515052668/5329489831328509))/(5329489831328509*(exp(- (562949953421312*V)/5329489831328509 - 16739365515052668/5329489831328509) + 1)^4);
dmA3dV = @(V) (105553116266496*exp(- (35184372088832*V)/1820115906168013 - 2678129957135078/1820115906168013))/(1820115906168013*(exp(- (35184372088832*V)/1820115906168013 - 2678129957135078/1820115906168013) + 1)^4);
dninfdV_v0 = @(V, v0) (281474976710656*exp((281474976710656*v0)/4600919484722715 - (281474976710656*V)/4600919484722715))/(4600919484722715*(exp((281474976710656*v0)/4600919484722715 - (281474976710656*V)/4600919484722715) + 1)^2);

% gA function
gAfun = @(V,n) ((-gNa*functions_CS.hinf_gen(functions_CS.inv_ninf_gen(n))...
    * ((dm3dV(V)*(V-ENa)) + functions_CS.minf_gen(V)^3) - gKDR*n^4 -gl))...
    / (functions_CS.hAinf_gen(functions_CS.inv_ninf_gen(n))*(dmA3dV(V)*(V-EKDR)...
    + functions_CS.mAinf_gen(V)^3));


%% loop gA-TC
for i = 1:length(v0_range)
    v0 = v0_range(i)
    
    %get coordinates of TC using the expression for gAfun
    v_TC = fsolve(@(V) dVdnC_v0(V, functions_CS.ninf_genV0(V, v0), ...
        gAfun(V, functions_CS.ninf_genV0(V, v0))) * dninfdV_v0(V, v0),...
        -53, options);
    n_TC = functions_CS.ninf_genV0(v_TC, v0);

    %get gA and Iapp at TC
    gA_TC(i) = fsolve(@(gA) dVdVC_v0(v_TC, n_TC, gA), 0, options);
    if gA_TC(i) < 0
        gA_TC(i) = NaN;
    else
        gA_TC(i) = gA_TC(i);
    end

end


end

